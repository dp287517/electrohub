<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ask Veeva â€“ Parcours ludique</title>
<style>
  :root{
    --bg:#f6f7fb;--ink:#111827;--muted:#6b7280;--brand:#2563eb;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
    --box:#ffffff;--edge:#e5e7eb;--shadow:0 8px 20px rgba(0,0,0,.08);
  }
  html,body{height:100%;}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:clamp(20px,3.5vw,32px);margin:0 0 12px}
  p.lead{color:var(--muted);margin:0 0 16px}

  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:900px){.grid{grid-template-columns:2fr 1fr}}

  .stage{position:relative;min-height:540px;border-radius:16px;background:linear-gradient(180deg,#fff, #f9fafb);box-shadow:var(--shadow);overflow:hidden}
  .panel{border-radius:16px;background:var(--box);box-shadow:var(--shadow);padding:14px}

  .box{position:absolute;min-width:160px;max-width:220px;padding:10px 12px;border:2px solid var(--edge);background:#fff;border-radius:14px}
  .box h3{margin:0 0 6px;font-size:15px}
  .box p{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
  .box .tag{display:inline-block;margin-top:6px;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:11px}

  .you{left:16px;top:24px}
  .front{left:16px;top:180px}
  .server{left:300px;top:140px}
  .py{left:560px;top:80px}
  .db{left:860px;top:60px}
  .openai{left:860px;top:240px}
  .queue{left:560px;top:260px}
  .store{left:300px;top:300px}

  .edge{position:absolute;height:2px;background:var(--edge);transform-origin:left center}
  .arrow::after{content:"";position:absolute;right:-8px;top:50%;width:0;height:0;border-left:8px solid var(--edge);border-top:6px solid transparent;border-bottom:6px solid transparent;transform:translateY(-50%)}

  .token{position:absolute;width:28px;height:28px;border-radius:50%;background:var(--brand);box-shadow:0 6px 18px rgba(37,99,235,.35);display:grid;place-items:center;color:#fff;font-weight:700}
  .bubble{position:absolute;max-width:240px;padding:8px 10px;border-radius:10px;background:#111827;color:#fff;font-size:12px;line-height:1.35;box-shadow:0 6px 18px rgba(0,0,0,.2)}
  .bubble::after{content:"";position:absolute;left:-6px;top:14px;border-right:6px solid #111827;border-top:6px solid transparent;border-bottom:6px solid transparent}

  .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .controls .card{border:1px solid var(--edge);border-radius:12px;padding:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0}
  .switch{position:relative;width:44px;height:24px;border-radius:999px;background:#e5e7eb;cursor:pointer}
  .switch input{display:none}
  .knob{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:.2s}
  .switch.on{background:#bbf7d0}
  .switch.on .knob{left:23px;background:#10b981}

  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--edge);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .trace{margin-top:8px;border-top:1px dashed var(--edge);padding-top:8px}
  .bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar > i{display:block;height:100%;background:var(--brand);width:0}
  .tiny{font-size:11px;color:var(--muted)}

  .doclist{max-height:260px;overflow:auto;margin-top:8px}
  .doc{font-size:12px;padding:6px 8px;border:1px solid var(--edge);border-radius:8px;background:#fff;margin-bottom:6px;display:flex;align-items:center;gap:8px}
  .dot{width:8px;height:8px;border-radius:50%;background:#a78bfa}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--edge);background:#fff}
  .anim{animation:pop .25s ease}
  @keyframes pop{0%{transform:scale(.9);opacity:.5}100%{transform:scale(1);opacity:1}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Parcours Ask Veeva (version jeu) ğŸ²</h1>
    <p class="lead">Clique sur <strong>"Lancer"</strong> pour voir ta question voyager : Frontend â†’ Serveur â†’ PySearch â†’ Base de donnÃ©es â†’ OpenAI â†’ RÃ©ponse.
      Les interrupteurs changent le comportement (DeepSearch, Rerank, MMR, ACL, Historique, File de jobs).</p>

    <div class="grid">
      <div class="stage" id="stage">
        <!-- Boxes (stations) -->
        <div class="box you anim"><h3>ğŸ‘¤ Toi</h3><p>Tu Ã©cris la question sur le tel ou le PC.</p><span class="tag">multi-device</span></div>
        <div class="box front anim"><h3>ğŸ§­ Frontend</h3><p>Normalise (SOP/N2000), hints langue & intent.</p><span class="tag">UI</span></div>
        <div class="box server anim"><h3>ğŸ§  Serveur (Node)</h3><p>Fusionne Hybrid+Vector, applique intents, ACL, historise.</p><span class="tag">API</span></div>
        <div class="box py anim"><h3>ğŸ” PySearch</h3><p>BM25 + TFâ€‘IDF + codes + rerank CE + MMR.</p><span class="tag">DeepSearch</span></div>
        <div class="box db anim"><h3>ğŸ—„ï¸ Postgres</h3><p>Chunks + embeddings + threads/messages.</p><span class="tag">pgvector</span></div>
        <div class="box openai anim"><h3>ğŸ¤– OpenAI</h3><p>RÃ©dige la rÃ©ponse Ã  partir du contexte.</p><span class="tag">LLM</span></div>
        <div class="box queue anim"><h3>ğŸ“¦ File jobs</h3><p>Ingestion lourde asynchrone (BullMQ/SQS).</p><span class="tag">queue</span></div>
        <div class="box store anim"><h3>ğŸ“ Stockage</h3><p>Fichiers originaux + preview texte.</p><span class="tag">store</span></div>

        <!-- Simple edges (for vibe) -->
        <div class="edge arrow" style="left:96px; top:76px; width:160px"></div>
        <div class="edge arrow" style="left:176px; top:200px; width:120px; transform:rotate(12deg)"></div>
        <div class="edge arrow" style="left:420px; top:170px; width:140px"></div>
        <div class="edge arrow" style="left:680px; top:120px; width:160px"></div>
        <div class="edge arrow" style="left:740px; top:260px; width:120px; transform:rotate(-12deg)"></div>
        <div class="edge arrow" style="left:420px; top:320px; width:140px"></div>

        <!-- Moving token & bubble -->
        <div id="token" class="token" style="left:40px; top:60px">Q</div>
        <div id="bubble" class="bubble" style="left:70px; top:60px; display:none"></div>
      </div>

      <div class="panel">
        <div class="controls">
          <div class="card">
            <div class="row"><strong>DeepSearch</strong>
              <label class="switch on" data-key="deep"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
            <div class="row"><span>Crossâ€‘encoder (rerank)</span>
              <label class="switch on" data-key="ce"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
            <div class="row"><span>MMR (diversitÃ©)</span>
              <label class="switch on" data-key="mmr"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
            <div class="row"><span>ACL espaces</span>
              <label class="switch on" data-key="acl"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
            <div class="row"><span>Historique multiâ€‘device</span>
              <label class="switch on" data-key="hist"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
            <div class="row"><span>File dâ€™ingestion</span>
              <label class="switch on" data-key="queue"><input type="checkbox" checked><span class="knob"></span></label>
            </div>
          </div>
          <div class="card">
            <div class="row">
              <button id="btnRun" class="btn primary">â–¶ Lancer</button>
              <button id="btnReset" class="btn">â†º Reset</button>
              <button id="btnSlow" class="btn">ğŸ¢</button>
              <button id="btnFast" class="btn">ğŸ‡</button>
            </div>
            <div class="trace">
              <div class="row"><span>Hybrid (PySearch)</span><span id="tHybrid">0%</span></div>
              <div class="bar"><i id="bHybrid"></i></div>
              <div class="row"><span>Vector (pgvector)</span><span id="tVector">0%</span></div>
              <div class="bar"><i id="bVector"></i></div>
              <div class="row"><span>Crossâ€‘Encoder</span><span id="tCE">0%</span></div>
              <div class="bar"><i id="bCE"></i></div>
              <div class="row"><span>MMR</span><span id="tMMR">0%</span></div>
              <div class="bar"><i id="bMMR"></i></div>
              <div class="tiny">Cette jauge montre Â« qui a pris le dessus Â» dans la dÃ©cision finale.
                Les interrupteurs influencent le score.
              </div>
            </div>

            <div class="legend">
              <span class="pill">ğŸ“œ Titres des documents (contexte)</span>
              <span class="pill">ğŸ§  DÃ©cision animÃ©e</span>
            </div>

            <div id="docList" class="doclist"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Simple demo state
  const switches = { deep:true, ce:true, mmr:true, acl:true, hist:true, queue:true };
  const stage = document.getElementById('stage');
  const token = document.getElementById('token');
  const bubble = document.getElementById('bubble');
  const btnRun = document.getElementById('btnRun');
  const btnReset = document.getElementById('btnReset');
  const btnSlow = document.getElementById('btnSlow');
  const btnFast = document.getElementById('btnFast');
  const speed = { v: 1.0 }; // 1 = normal, 0.5 = slow, 2 = fast

  // Simple bars
  const bars = {
    Hybrid: [document.getElementById('bHybrid'), document.getElementById('tHybrid')],
    Vector: [document.getElementById('bVector'), document.getElementById('tVector')],
    CE:     [document.getElementById('bCE'), document.getElementById('tCE')],
    MMR:    [document.getElementById('bMMR'), document.getElementById('tMMR')],
  };

  function setBar(name, pct){
    const [el, label] = bars[name];
    const p = Math.max(0, Math.min(100, Math.round(pct)));
    el.style.width = p + '%';
    label.textContent = p + '%';
  }
  function resetBars(){ ['Hybrid','Vector','CE','MMR'].forEach(n=>setBar(n,0)); }

  // Toggle wiring
  document.querySelectorAll('.switch').forEach(sw=>{
    sw.addEventListener('click', ()=>{
      sw.classList.toggle('on');
      const k = sw.getAttribute('data-key');
      switches[k] = sw.classList.contains('on');
    });
  });

  btnSlow.onclick = ()=> speed.v = 0.6;
  btnFast.onclick = ()=> speed.v = 1.8;

  function speak(text, x, y){
    bubble.textContent = text;
    bubble.style.left = (x||parseFloat(token.style.left)+30) + 'px';
    bubble.style.top = (y||parseFloat(token.style.top)-6) + 'px';
    bubble.style.display = 'block';
  }
  function hideSpeak(){ bubble.style.display='none'; }

  function moveTo(x, y, ms){
    return new Promise(res=>{
      const sx = parseFloat(token.style.left)||0;
      const sy = parseFloat(token.style.top)||0;
      const dx = x - sx, dy = y - sy;
      const T = Math.max(120, ms) / speed.v;
      const t0 = performance.now();
      (function step(t){
        const u = Math.min(1, (t - t0) / T);
        token.style.left = (sx + dx*u) + 'px';
        token.style.top  = (sy + dy*u) + 'px';
        if(u < 1) requestAnimationFrame(step); else res();
      })(t0);
    });
  }

  function sampleDecision(){
    // Produce a decision mix influenced by switches
    let hybrid = 40 + (switches.deep?20:0);
    let vector = 40 - (switches.deep?10:0);
    let ce = switches.ce? 25 : 5;
    let mmr = switches.mmr? 20 : 5;
    // Normalize to 100
    const sum = hybrid + vector + ce + mmr; 
    hybrid = hybrid/sum*100; vector = vector/sum*100; ce = ce/sum*100; mmr = mmr/sum*100;
    return { hybrid, vector, ce, mmr };
  }

  function renderDocTitles(){
    const list = document.getElementById('docList');
    list.innerHTML = '';
    // Fake titles like in contexts (only titles, not snippets)
    const titles = [
      'QD-SOP-038904 â€“ Gestion des dÃ©chets',
      'IDR â€“ RÃ©glage N2000-2 microdoseur',
      'Check-list sÃ©curitÃ© â€“ Zone LIQ',
      'Politique EHS site â€“ VFD',
      'ProcÃ©dure de nettoyage â€“ Ligne 9142'
    ];
    titles.forEach(t=>{
      const d = document.createElement('div');
      d.className = 'doc';
      d.innerHTML = '<span class="dot"></span><span>'+t+'</span>';
      list.appendChild(d);
    });
  }

  async function run(){
    btnRun.disabled = true; resetBars(); hideSpeak(); renderDocTitles();
    // Starting position near "you"
    token.style.left = '40px'; token.style.top = '60px';
    speak('Bonjour ! Pose ta questionâ€¦');
    await wait(700);
    hideSpeak();

    // You -> Frontend
    speak('Normalisation (SOPâ†’QDâ€‘SOPâ€‘xxxxxx), langue & intent');
    await moveTo(70, 210, 900);
    await wait(200);

    // Frontend -> Server
    speak('Envoi au serveur (profil, thread, ACL, history)');
    await moveTo(340, 170, 900);
    await wait(150);

    // Server -> PySearch
    if(switches.deep){
      speak('DeepSearch: BM25 + TFâ€‘IDF + codesâ€¦');
      await moveTo(600, 110, 900);
      await wait(200);
      if(switches.ce){ speak('Rerank Crossâ€‘Encoder'); await wait(500); }
      if(switches.mmr){ speak('MMR pour varier les extraits'); await wait(500); }
    }

    // PySearch -> DB
    speak('RÃ©cupÃ¨re les meilleurs chunks (pgvector + BM25)');
    await moveTo(900, 90, 900);
    await wait(250);

    // Server maybe queue/store side quests
    if(switches.queue){ speak('Ingestion lourde â†’ file de jobs'); await moveTo(600, 280, 750); await wait(250); }
    speak('Retrouve les fichiers originaux');
    await moveTo(340, 330, 700);
    await wait(200);

    // Server -> OpenAI
    speak('Construit le prompt et demande la rÃ©ponse');
    await moveTo(900, 270, 900);
    await wait(400);

    // Back to you
    const mix = sampleDecision();
    setBar('Hybrid', mix.hybrid);
    setBar('Vector', mix.vector);
    setBar('CE', mix.ce);
    setBar('MMR', mix.mmr);

    speak('RÃ©ponse livrÃ©e avec citations ğŸ‰');
    await moveTo(60, 80, 1200);
    await wait(250);

    hideSpeak(); btnRun.disabled = false;
  }

  function wait(ms){ return new Promise(r=>setTimeout(r, ms / speed.v)); }

  btnRun.onclick = run;
  btnReset.onclick = ()=>{ resetBars(); hideSpeak(); token.style.left='40px'; token.style.top='60px'; };
  renderDocTitles();
})();
</script>
</body>
</html>
